# 账单复盘功能前端集成 - 需求发现报告

**项目**: Notion Bill Importer
**功能**: 账单复盘功能前端集成
**日期**: 2026-02-03
**阶段**: Discovery - 需求发现

---

## 一、需求摘要

为 Notion Bill Importer 项目的账单导入服务添加前端复盘功能。用户在账单导入成功后，可以选择生成周期性（月度/季度/年度）复盘报告，帮助用户更好地分析和理解自己的消费行为。

### 核心功能
1. **复盘配置管理** - 在设置页面配置复盘数据库和模板
2. **智能提示复盘** - 账单导入成功后自动提示生成复盘
3. **复盘报告管理** - 独立的复盘管理页面

---

## 二、用户故事

### 主要用户故事

**US-1: 配置复盘数据库**
> 作为用户，我希望在设置页面配置复盘数据库，以便系统能够将复盘报告写入我的 Notion 工作区。

**US-2: 导入后生成复盘**
> 作为用户，我希望在账单导入成功后能够一键生成本月复盘，以便快速了解我的消费情况。

**US-3: 管理复盘报告**
> 作为用户，我希望有一个专门的页面来管理和生成复盘报告，以便随时查看历史复盘和生成新的报告。

---

## 三、验收标准

### 功能性验收标准

| ID | 验收标准 | 优先级 |
|----|----------|--------|
| F1 | 用户可以在设置页面配置月度/季度/年度复盘数据库ID | P0 |
| F2 | 用户可以配置复盘模板ID（可选） | P1 |
| F3 | 系统可以验证复盘配置是否正确 | P0 |
| F4 | 账单导入成功后显示复盘提示Banner | P0 |
| F5 | Banner显示本月交易统计信息 | P1 |
| F6 | 用户可以从Banner一键生成本月复盘 | P0 |
| F7 | 用户可以关闭Banner（稍后提醒） | P1 |
| F8 | 复盘管理页面可以快速生成月度/季度/年度复盘 | P0 |
| F9 | 用户可以自定义年/月/季度生成复盘 | P0 |
| F10 | 系统支持复盘数据预览 | P1 |
| F11 | 导航栏有复盘入口 | P0 |

### 非功能性验收标准

| ID | 验收标准 | 目标值 |
|----|----------|--------|
| NF1 | 页面响应时间 | < 2秒 |
| NF2 | 移动端兼容性 | 完全支持 |
| NF3 | 浏览器兼容性 | Chrome, Firefox, Safari, Edge |
| NF4 | 代码质量 | 符合项目编码规范 |
| NF5 | 代码注释率 | 关键函数需有注释 |

---

## 四、约束条件

### 技术约束
1. **前端技术栈**: Vanilla JavaScript，不使用框架
2. **模板引擎**: Jinja2
3. **后端框架**: FastAPI
4. **数据库**: SQLite (多租户模式)
5. **后端API**: 已完整实现，不可修改

### 业务约束
1. **多租户支持**: 必须支持多用户模式
2. **权限控制**: 仅登录用户可访问
3. **配置隔离**: 每个用户的复盘配置独立

### 设计约束
1. **UI一致性**: 必须与现有设计风格保持一致
2. **响应式设计**: 必须支持移动端
3. **无障碍性**: 符合基本的无障碍标准

---

## 五、风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Review Router未注册导致API不可用 | 高 | 中 | 优先在main.py中注册router |
| 用户体验风险（导入后提示打扰用户） | 中 | 中 | 提供"不再提示"选项 |
| 浏览器兼容性问题 | 低 | 低 | 使用标准API，充分测试 |
| 移动端显示问题 | 中 | 低 | 响应式设计，测试多种屏幕尺寸 |

---

## 六、复杂度评估

| 维度 | 评分 (1-5) | 等级 | 说明 |
|------|------------|------|------|
| **功能复杂度** | 4 | 中等 | 涉及多个页面交互，API调用较复杂 |
| **技术复杂度** | 3 | 低-中 | 后端已完成，前端开发难度适中 |
| **规模复杂度** | 3 | 低-中 | 约7-10个文件，代码量约800行 |
| **风险复杂度** | 3 | 低-中 | 技术债务可控，风险较低 |
| **综合得分** | 15.1/40 | 中等 | 属于中等复杂度项目 |

**推荐开发模式**: 瀑布流

---

## 七、技术实现建议

### 前端架构
- 使用 IIFE 模式封装 JavaScript 代码
- 统一使用 `window.Auth.apiRequest()` 进行 API 调用
- 统一使用 `showToast()` 进行消息提示

### 页面结构
```
settings.html          # 添加复盘配置section
bill_management.html   # 添加复盘提示Banner
review.html           # 新建复盘管理页面
navbar.html           # 添加复盘导航链接
```

### API 集成
```
POST /api/review/generate    # 生成复盘
GET  /api/review/preview     # 预览复盘
GET  /api/review/config      # 获取配置
POST /api/review/config      # 更新配置
```

---

## 八、API 参考

### 1. 生成复盘报告
```
POST /api/review/generate
Content-Type: application/json

Request:
{
  "review_type": "monthly|quarterly|yearly",
  "year": 2024,
  "month": 1,        // monthly时必填
  "quarter": 1       // quarterly时必填
}

Response:
{
  "success": true,
  "period": "2024-01",
  "page_id": "xxx",
  "data": { ... }
}
```

### 2. 预览复盘数据
```
GET /api/review/preview?review_type=monthly&year=2024&month=1

Response:
{
  "period": "2024-01",
  "start_date": "2024-01-01",
  "end_date": "2024-01-31",
  "summary": {
    "total_income": 10000,
    "total_expense": 5000,
    "net_balance": 5000,
    "transaction_count": 100
  },
  "categories": { ... },
  "transaction_count": 100
}
```

### 3. 获取复盘配置
```
GET /api/review/config

Response:
{
  "monthly_review_db": "xxx",
  "quarterly_review_db": "xxx",
  "yearly_review_db": "xxx",
  "monthly_template_id": "xxx",
  "quarterly_template_id": "xxx",
  "yearly_template_id": "xxx"
}
```

### 4. 更新复盘配置
```
POST /api/review/config
Content-Type: application/json

Request:
{
  "notion_monthly_review_db": "xxx",
  "notion_quarterly_review_db": "xxx",
  "notion_yearly_review_db": "xxx",
  "notion_monthly_template_id": "xxx",
  "notion_quarterly_template_id": "xxx",
  "notion_yearly_template_id": "xxx"
}

Response:
{
  "success": true,
  "message": "配置已更新"
}
```

---

## 九、待澄清问题

### 已确认
- ✅ 后端API已完整实现
- ✅ 复盘配置已集成到数据模型
- ✅ 需要在前端实现用户交互界面

### 待讨论
1. **复盘历史数据来源**: 需要后端提供复盘列表API
2. **用户偏好设置**: 是否需要记录用户对"不再提示"的选择
3. **批量生成复盘**: 是否需要支持批量生成多个周期的复盘

---

## 十、附录

### 相关文件
- `review_service.py` - 后端复盘服务
- `web_service/routes/review.py` - 后端API路由
- `models.py` - 数据模型（UserNotionConfig）
- `.env.example` - 环境变量配置示例

### 设计决策记录
| 决策点 | 决策 | 理由 |
|--------|------|------|
| 配置位置 | 设置页面 | 符合用户习惯 |
| 提示方式 | Banner | 非侵入式，可关闭 |
| 管理位置 | 独立页面 | 完整功能，易于扩展 |

---

**文档版本**: 1.0
**最后更新**: 2026-02-03
