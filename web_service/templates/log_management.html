<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—ç®¡ç† - ä¸ªäººè´¢åŠ¡ç®¡ç†å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/variables.css">
</head>
<body>
    <!-- å¯¼èˆªæ ç»„ä»¶ -->
    {% include "components/navbar.html" %}

    <div class="container" style="margin-top: 80px;">
        <main class="log-main">
            <div class="page-header">
                <h1>æ—¥å¿—ç®¡ç†</h1>
                <p>æŸ¥çœ‹å’Œç®¡ç†ç³»ç»Ÿè¿è¡Œæ—¥å¿—</p>
            </div>

            <div class="log-controls">
                <div class="log-filters">
                    <div class="log-filter">
                        <label for="log-level">æ—¥å¿—çº§åˆ«:</label>
                        <select id="log-level">
                            <option value="all">æ‰€æœ‰çº§åˆ«</option>
                            <option value="INFO">INFO</option>
                            <option value="ERROR">ERROR</option>
                            <option value="WARNING">WARNING</option>
                            <option value="DEBUG">DEBUG</option>
                        </select>
                    </div>
                    <div class="log-filter">
                        <label for="search-input">æœç´¢:</label>
                        <input type="text" id="search-input" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." class="search-input">
                    </div>
                    <div class="log-filter">
                        <label for="start-time">å¼€å§‹æ—¶é—´:</label>
                        <input type="datetime-local" id="start-time" class="time-input">
                    </div>
                    <div class="log-filter">
                        <label for="end-time">ç»“æŸæ—¶é—´:</label>
                        <input type="datetime-local" id="end-time" class="time-input">
                    </div>
                    <button class="btn btn-secondary btn-sm" id="clear-filters">
                        <span>âœ•</span> æ¸…é™¤ç­›é€‰
                    </button>
                </div>
                <div class="log-actions">
                    <button class="btn btn-secondary" id="refresh-logs">
                        <span>ğŸ”„ åˆ·æ–°</span>
                    </button>
                    <button class="btn btn-secondary" id="clear-logs">
                        <span>ğŸ—‘ æ¸…ç©º</span>
                    </button>
                </div>
            </div>

            <div class="log-stats">
                <span>å…± <strong id="total-count">0</strong> æ¡æ—¥å¿—</span>
                <span>æ˜¾ç¤º <strong id="displayed-count">0</strong> æ¡</span>
            </div>

            <div class="log-content">
                <div class="log-container" id="log-container">
                    <div class="log-loading">åŠ è½½æ—¥å¿—ä¸­...</div>
                </div>
            </div>
        </main>

        <footer>
            <p>Â© 2026 ä¸ªäººè´¢åŠ¡ç®¡ç†å¹³å° - æ™ºèƒ½è´¦å•ç®¡ç†ä¸è´¢åŠ¡å¤ç›˜</p>
        </footer>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/navbar.js"></script>
    <script>
    (function() {
        'use strict';

        const logContainer = document.getElementById('log-container');
        const logLevelSelect = document.getElementById('log-level');
        const searchInput = document.getElementById('search-input');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const refreshBtn = document.getElementById('refresh-logs');
        const clearBtn = document.getElementById('clear-logs');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const totalCountEl = document.getElementById('total-count');
        const displayedCountEl = document.getElementById('displayed-count');

        let currentLogs = [];
        let filteredLogs = [];

        // åŒ—äº¬æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ—¶é—´å·²ç»æ˜¯åŒ—äº¬æ—¶é—´ï¼Œç›´æ¥æ˜¾ç¤ºï¼‰
        function formatBeijingTime(timestamp) {
            if (!timestamp) return '-';
            // æ—¥å¿—æ–‡ä»¶ä¸­çš„æ—¶é—´æ ¼å¼: YYYY-MM-DD HH:MM:SS
            return timestamp;
        }

        // å°† datetime-local æ ¼å¼è½¬æ¢ä¸ºæ—¥å¿—æ—¶é—´æ ¼å¼
        function datetimeLocalToLogTime(datetimeLocal) {
            if (!datetimeLocal) return null;
            // datetime-local æ ¼å¼: YYYY-MM-DDTHH:MM
            // è½¬æ¢ä¸º: YYYY-MM-DD HH:MM:SS
            return datetimeLocal.replace('T', ' ') + ':00';
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                logContainer.innerHTML = '<div class="log-loading">åŠ è½½æ—¥å¿—ä¸­...</div>';

                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams({ limit: 500 });
                const level = logLevelSelect.value;
                if (level !== 'all') {
                    params.append('level', level);
                }
                if (searchInput.value.trim()) {
                    params.append('search', searchInput.value.trim());
                }
                if (startTimeInput.value) {
                    const startTime = datetimeLocalToLogTime(startTimeInput.value);
                    if (startTime) params.append('start_time', startTime);
                }
                if (endTimeInput.value) {
                    const endTime = datetimeLocalToLogTime(endTimeInput.value);
                    if (endTime) params.append('end_time', endTime);
                }

                const response = await window.Auth.apiRequest(`/api/admin/logs?${params.toString()}`);
                if (response && response.ok) {
                    const data = await response.json();
                    currentLogs = data.logs || [];
                    filteredLogs = currentLogs;
                    updateStats();
                    renderLogs();
                } else {
                    logContainer.innerHTML = '<div class="log-error">åŠ è½½æ—¥å¿—å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
                logContainer.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—è®°å½•</div>';
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            totalCountEl.textContent = currentLogs.length;
            displayedCountEl.textContent = filteredLogs.length;
        }

        // æ¸²æŸ“æ—¥å¿—
        function renderLogs() {
            if (filteredLogs.length === 0) {
                logContainer.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—è®°å½•</div>';
                updateStats();
                return;
            }

            logContainer.innerHTML = filteredLogs.map(log => `
                <div class="log-entry log-${log.level.toLowerCase()}">
                    <div class="log-meta">
                        <span class="log-time">${escapeHtml(formatBeijingTime(log.timestamp))}</span>
                        <span class="log-level">${escapeHtml(log.level)}</span>
                        ${log.logger ? `<span class="log-logger">${escapeHtml(log.logger)}</span>` : ''}
                        ${log.location ? `<span class="log-location">${escapeHtml(log.location)}</span>` : ''}
                    </div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                </div>
            `).join('');
            updateStats();
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            logLevelSelect.value = 'all';
            searchInput.value = '';
            startTimeInput.value = '';
            endTimeInput.value = '';
            loadLogs();
        }

        // äº‹ä»¶ç›‘å¬
        logLevelSelect.addEventListener('change', loadLogs);
        searchInput.addEventListener('input', debounce(loadLogs, 500));
        startTimeInput.addEventListener('change', loadLogs);
        endTimeInput.addEventListener('change', loadLogs);
        clearFiltersBtn.addEventListener('click', clearFilters);

        refreshBtn.addEventListener('click', loadLogs);

        clearBtn.addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;

            try {
                const response = await window.Auth.apiRequest('/api/admin/logs', { method: 'DELETE' });
                if (response && response.ok) {
                    currentLogs = [];
                    filteredLogs = [];
                    renderLogs();
                    alert('æ—¥å¿—å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('Failed to clear logs:', error);
                alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥');
            }
        });

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // è‡ªåŠ¨åˆ·æ–°
        let autoRefreshInterval;
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(loadLogs, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ§åˆ¶è‡ªåŠ¨åˆ·æ–°
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                loadLogs();
                startAutoRefresh();
            }
        });

        // åˆå§‹åŒ–
        loadLogs();
        startAutoRefresh();
    })();
    </script>

    <style>
    /* ==================== æ—¥å¿—ç®¡ç† - Linuxç»ˆç«¯é£æ ¼ï¼ˆä»…æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸï¼‰ ==================== */

    .log-main {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        margin-bottom: 16px;
    }

    .page-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #e5e7eb;
    }

    .page-header p {
        color: #9ca3af;
        font-size: 0.85rem;
    }

    /* æ§åˆ¶åŒºåŸŸ */
    .log-controls {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .log-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .log-filter {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .log-filter label {
        color: #9ca3af;
        font-weight: 500;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .log-filter select,
    .search-input,
    .time-input {
        padding: 6px 10px;
        border: 1px solid #374151;
        border-radius: 4px;
        background: #1f2937;
        color: #e5e7eb;
        font-size: 0.8rem;
    }

    .log-filter select:focus,
    .search-input:focus,
    .time-input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .search-input {
        width: 180px;
    }

    .time-input {
        width: 160px;
    }

    .log-actions {
        display: flex;
        gap: 8px;
    }

    .log-actions .btn {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    /* ç»Ÿè®¡ä¿¡æ¯ */
    .log-stats {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        padding: 8px 12px;
        background: #1f2937;
        border-radius: 4px;
        color: #9ca3af;
        font-size: 0.8rem;
    }

    .log-stats strong {
        color: #e5e7eb;
    }

    /* æ—¥å¿—å®¹å™¨ - ç»ˆç«¯é£æ ¼ */
    .log-content {
        background: #0d1117;
        border-radius: 6px;
        border: 1px solid #30363d;
        overflow: hidden;
    }

    .log-container {
        max-height: calc(100vh - 280px);
        min-height: 400px;
        overflow-y: auto;
        background: #0d1117;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    .log-container::-webkit-scrollbar {
        width: 10px;
    }

    .log-container::-webkit-scrollbar-track {
        background: #161b22;
    }

    .log-container::-webkit-scrollbar-thumb {
        background: #30363d;
        border-radius: 5px;
    }

    .log-container::-webkit-scrollbar-thumb:hover {
        background: #484f58;
    }

    .log-loading,
    .log-empty,
    .log-error {
        padding: 40px;
        text-align: center;
        color: #8b949e;
        font-family: 'Monaco', 'Consolas', 'SF Mono', monospace;
    }

    /* å•æ¡æ—¥å¿— - ç´§å‡‘é£æ ¼ */
    .log-entry {
        display: flex;
        align-items: flex-start;
        padding: 2px 8px;
        border-bottom: 1px solid #21262d;
        font-family: 'SF Mono', 'Monaco', 'Consolas', 'Liberation Mono', monospace;
        font-size: 0.75rem;
        line-height: 1.4;
        color: #c9d1d9;
        background: #0d1117;
        transition: background 0.1s ease;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-entry:hover {
        background: #161b22;
    }

    /* æ—¶é—´æˆ³ */
    .log-time {
        color: #8b949e;
        flex-shrink: 0;
        margin-right: 8px;
    }

    /* æ—¥å¿—çº§åˆ« - å½©è‰²æ–‡å­—ï¼ˆLinuxé£æ ¼ï¼‰ */
    .log-level {
        font-weight: 600;
        flex-shrink: 0;
        margin-right: 8px;
        text-transform: uppercase;
    }

    /* INFO - è“è‰² */
    .log-info .log-level {
        color: #58a6ff;
    }

    /* ERROR - çº¢è‰² */
    .log-error .log-level {
        color: #ff7b72;
    }

    /* WARNING - é»„è‰² */
    .log-warning .log-level {
        color: #d29922;
    }

    /* DEBUG - ç°è‰² */
    .log-debug .log-level {
        color: #8b949e;
    }

    /* Loggerå’Œä½ç½® */
    .log-logger,
    .log-location {
        color: #7ee787;
        flex-shrink: 0;
        margin-right: 8px;
    }

    .log-logger::after {
        content: ":";
        color: #8b949e;
    }

    .log-location {
        color: #79c0ff;
    }

    /* æ—¥å¿—æ¶ˆæ¯ */
    .log-message {
        color: #c9d1d9;
        word-break: break-all;
        flex: 1;
    }

    /* ERRORçº§åˆ«çš„æ¶ˆæ¯ç”¨çº¢è‰² */
    .log-error .log-message {
        color: #ffa198;
    }

    /* ERRORæ—¥å¿—æ•´è¡Œå¾®çº¢èƒŒæ™¯æç¤º */
    .log-error {
        background: rgba(248, 81, 73, 0.05);
    }

    /* å“åº”å¼ */
    @media (max-width: 1024px) {
        .log-filters {
            flex-direction: column;
            align-items: stretch;
        }

        .search-input,
        .time-input {
            width: 100%;
        }

        .log-controls {
            flex-direction: column;
        }

        .log-actions {
            width: 100%;
            justify-content: stretch;
        }

        .log-actions button {
            flex: 1;
        }

        .log-container {
            max-height: calc(100vh - 320px);
        }
    }
    </style>
</body>
</html>
