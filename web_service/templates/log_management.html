<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—ç®¡ç† - Notionè´¦å•å¯¼å…¥æœåŠ¡</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/variables.css">
</head>
<body>
    <!-- å¯¼èˆªæ ç»„ä»¶ -->
    {% include "components/navbar.html" %}

    <div class="container" style="margin-top: 80px;">
        <main class="log-main">
            <div class="page-header">
                <h1>æ—¥å¿—ç®¡ç†</h1>
                <p>æŸ¥çœ‹å’Œç®¡ç†ç³»ç»Ÿè¿è¡Œæ—¥å¿—</p>
            </div>

            <div class="log-controls">
                <div class="log-filter">
                    <label for="log-level">æ—¥å¿—çº§åˆ«:</label>
                    <select id="log-level">
                        <option value="all">æ‰€æœ‰çº§åˆ«</option>
                        <option value="INFO">INFO</option>
                        <option value="ERROR">ERROR</option>
                        <option value="WARNING">WARNING</option>
                        <option value="DEBUG">DEBUG</option>
                    </select>
                </div>
                <div class="log-actions">
                    <button class="btn btn-secondary" id="refresh-logs">
                        <span>ğŸ”„ åˆ·æ–°</span>
                    </button>
                    <button class="btn btn-secondary" id="clear-logs">
                        <span>ğŸ—‘ æ¸…ç©º</span>
                    </button>
                </div>
            </div>

            <div class="log-content">
                <div class="log-container" id="log-container">
                    <div class="log-loading">åŠ è½½æ—¥å¿—ä¸­...</div>
                </div>
            </div>
        </main>

        <footer>
            <p>Â© 2025 Notionè´¦å•å¯¼å…¥æœåŠ¡ - å¤šç§Ÿæˆ·SaaSå¹³å°</p>
        </footer>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/navbar.js"></script>
    <script>
    (function() {
        'use strict';

        const logContainer = document.getElementById('log-container');
        const logLevelSelect = document.getElementById('log-level');
        const refreshBtn = document.getElementById('refresh-logs');
        const clearBtn = document.getElementById('clear-logs');

        let currentLogs = [];
        let filteredLogs = [];

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                logContainer.innerHTML = '<div class="log-loading">åŠ è½½æ—¥å¿—ä¸­...</div>';

                const response = await fetch('/api/admin/logs?limit=500');
                if (response.ok) {
                    const data = await response.json();
                    currentLogs = data.logs || [];
                    filterLogs();
                } else {
                    logContainer.innerHTML = '<div class="log-error">åŠ è½½æ—¥å¿—å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
                logContainer.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—è®°å½•</div>';
            }
        }

        // è¿‡æ»¤æ—¥å¿—
        function filterLogs() {
            const level = logLevelSelect.value;
            filteredLogs = level === 'all'
                ? currentLogs
                : currentLogs.filter(log => log.level === level);
            renderLogs();
        }

        // æ¸²æŸ“æ—¥å¿—
        function renderLogs() {
            if (filteredLogs.length === 0) {
                logContainer.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—è®°å½•</div>';
                return;
            }

            logContainer.innerHTML = filteredLogs.map(log => `
                <div class="log-entry log-${log.level.toLowerCase()}">
                    <div class="log-meta">
                        <span class="log-time">${formatTime(log.timestamp)}</span>
                        <span class="log-level">${log.level}</span>
                    </div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                    ${log.details ? `<div class="log-details">${escapeHtml(log.details)}</div>` : ''}
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // äº‹ä»¶ç›‘å¬
        logLevelSelect.addEventListener('change', filterLogs);

        refreshBtn.addEventListener('click', loadLogs);

        clearBtn.addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;

            try {
                const response = await fetch('/api/admin/logs', { method: 'DELETE' });
                if (response.ok) {
                    currentLogs = [];
                    filteredLogs = [];
                    renderLogs();
                    alert('æ—¥å¿—å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('Failed to clear logs:', error);
                alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥');
            }
        });

        // è‡ªåŠ¨åˆ·æ–°
        let autoRefreshInterval;
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(loadLogs, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ§åˆ¶è‡ªåŠ¨åˆ·æ–°
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                loadLogs();
                startAutoRefresh();
            }
        });

        // åˆå§‹åŒ–
        loadLogs();
        startAutoRefresh();
    })();
    </script>

    <style>
    .log-main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        margin-bottom: 24px;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: #1a1a2e;
    }

    .page-header p {
        color: #6b7280;
    }

    .log-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .log-filter {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .log-filter label {
        color: #4b5563;
        font-weight: 500;
    }

    .log-filter select {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: white;
        font-size: 0.9rem;
    }

    .log-actions {
        display: flex;
        gap: 12px;
    }

    .log-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .log-container {
        max-height: 600px;
        overflow-y: auto;
    }

    .log-loading,
    .log-empty,
    .log-error {
        padding: 40px;
        text-align: center;
        color: #6b7280;
    }

    .log-entry {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.85rem;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-entry:hover {
        background: #f9fafb;
    }

    .log-meta {
        display: flex;
        gap: 12px;
        margin-bottom: 4px;
    }

    .log-time {
        color: #6b7280;
    }

    .log-level {
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .log-info .log-level {
        background: #dbeafe;
        color: #1e40af;
    }

    .log-error .log-level {
        background: #fee2e2;
        color: #991b1b;
    }

    .log-warning .log-level {
        background: #fef3c7;
        color: #92400e;
    }

    .log-debug .log-level {
        background: #f3f4f6;
        color: #374151;
    }

    .log-message {
        color: #1a1a2e;
        word-break: break-all;
    }

    .log-details {
        margin-top: 8px;
        padding: 8px;
        background: #f9fafb;
        border-radius: 4px;
        color: #6b7280;
        font-size: 0.8rem;
    }

    @media (max-width: 640px) {
        .log-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .log-actions {
            justify-content: stretch;
        }

        .log-actions button {
            flex: 1;
        }
    }
    </style>
</body>
</html>
