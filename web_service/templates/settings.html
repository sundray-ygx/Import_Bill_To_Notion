<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账户设置 - Notion账单导入服务</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/settings.css">
    <!-- 性能优化：CSS变量系统 -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <!-- 资源预加载 -->
    <link rel="preload" href="/static/js/perf-utils.js" as="script">
</head>
<body>
    <!-- 导航栏组件 -->
    {% include "components/navbar.html" %}

    <main class="settings-main">
        <div class="settings-container">
            <!-- 侧边栏导航 -->
            <aside class="settings-sidebar">
                <div class="sidebar-section">
                    <h3>账户设置</h3>
                    <nav class="sidebar-nav">
                        <a href="#profile" class="sidebar-item active" data-section="profile">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span>个人资料</span>
                        </a>
                        <a href="#security" class="sidebar-item" data-section="security">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            <span>安全设置</span>
                        </a>
                        <a href="#notion" class="sidebar-item" data-section="notion">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                            </svg>
                            <span>Notion配置</span>
                        </a>
                        <a href="#review" class="sidebar-item" data-section="review">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                            <span>复盘配置</span>
                        </a>
                    </nav>
                </div>
            </aside>

            <!-- 主内容区 -->
            <div class="settings-content">
                <!-- 个人资料卡片 -->
                <section class="settings-section" id="profile-section">
                    <h2>个人资料</h2>

                    <div class="profile-card">
                        <div class="profile-avatar-section">
                            <svg class="profile-avatar-large" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <div>
                                <h3 id="profile-username" style="margin: 0 0 4px 0; font-size: 1.25rem;">加载中...</h3>
                                <p id="profile-email" style="margin: 0; color: #6b7280;">加载中...</p>
                            </div>
                        </div>

                        <form class="profile-form" id="profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>用户名</label>
                                    <input type="text" id="profile-username-input" class="form-input" readonly>
                                    <div class="form-hint">用户名不能修改</div>
                                </div>

                                <div class="form-group">
                                    <label>电子邮箱</label>
                                    <input type="email" id="profile-email-input" class="form-input" required>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" id="cancel-profile-btn">取消</button>
                                <button type="submit" class="btn btn-primary">保存更改</button>
                            </div>
                        </form>

                        <!-- 账户统计 -->
                        <div class="stats-card">
                            <h3>账户统计</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value" id="stat-uploads">0</div>
                                    <div class="stat-label">总上传次数</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="stat-records">0</div>
                                    <div class="stat-label">导入记录数</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="stat-days">0天</div>
                                    <div class="stat-label">注册时长</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 安全设置卡片 -->
                <section class="settings-section" id="security-section" style="display: none;">
                    <h2>安全设置</h2>

                    <div class="security-card">
                        <form id="password-form">
                            <h3>修改密码</h3>

                            <div class="form-group">
                                <label>当前密码</label>
                                <input type="password" id="current-password" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label>新密码</label>
                                <div class="input-with-icon">
                                    <input type="password" id="new-password" class="form-input" required minlength="8">
                                    <button type="button" class="input-icon" id="toggle-new-password" aria-label="显示/隐藏密码">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </button>
                                </div>

                                <!-- 密码强度指示器 -->
                                <div class="password-strength">
                                    <div class="strength-bar">
                                        <div class="strength-fill" id="password-strength-fill"></div>
                                    </div>
                                    <div class="strength-text" id="password-strength-text">密码强度：未输入</div>
                                </div>

                                <div class="form-hint">至少8个字符，包含大小写字母和数字</div>
                            </div>

                            <div class="form-group">
                                <label>确认新密码</label>
                                <input type="password" id="confirm-new-password" class="form-input" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">更新密码</button>
                            </div>
                        </form>
                    </div>

                    <!-- 会话超时设置 -->
                    <div class="session-timeout-card">
                        <h3>会话超时设置</h3>
                        <p class="card-description">设置控制台会话的超时时间，超时后需要重新登录</p>

                        <form id="session-timeout-form">
                            <div class="form-group">
                                <label for="session-timeout">控制台超时时间（分钟）</label>
                                <div class="timeout-input-group">
                                    <input type="number"
                                           id="session-timeout"
                                           class="form-input"
                                           min="5"
                                           max="1440"
                                           step="5"
                                           value="15"
                                           required>
                                    <div class="timeout-unit">分钟</div>
                                </div>
                                <div class="form-hint">
                                    建议值：15-120 分钟。超时后需要重新登录以保护账户安全。
                                </div>
                            </div>

                            <div class="timeout-presets">
                                <button type="button" class="timeout-preset-btn" data-timeout="15">15分钟</button>
                                <button type="button" class="timeout-preset-btn" data-timeout="30">30分钟</button>
                                <button type="button" class="timeout-preset-btn" data-timeout="60">1小时</button>
                                <button type="button" class="timeout-preset-btn" data-timeout="120">2小时</button>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">保存设置</button>
                            </div>
                        </form>
                    </div>

                    <!-- 会话管理 -->
                    <div class="sessions-card">
                        <h3>活跃会话</h3>
                        <div class="sessions-list" id="sessions-list">
                            <!-- 动态加载 -->
                            <div class="session-item">
                                <div class="session-info">
                                    <span class="session-device">当前浏览器</span>
                                    <span class="session-time">刚刚</span>
                                </div>
                                <span class="badge badge-success">当前</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" id="revoke-all-sessions-btn" style="margin-top: 16px;">
                            撤销所有其他会话
                        </button>
                    </div>

                    <!-- 危险区域 - 注销账户 -->
                    <div class="danger-zone-card" style="margin-top: 24px;">
                        <h3>危险区域</h3>
                        <p style="color: #6b7280; margin-bottom: 16px;">以下操作不可撤销，请谨慎操作</p>

                        <div class="danger-item">
                            <div class="danger-item-content">
                                <h4>注销账户</h4>
                                <p>永久删除您的账户和所有相关数据，包括上传的文件、导入记录和Notion配置</p>
                            </div>
                            <button class="btn btn-danger" id="delete-account-btn">注销账户</button>
                        </div>
                    </div>
                </section>

                <!-- Notion配置卡片 -->
                <section class="settings-section" id="notion-section" style="display: none;">
                    <h2>Notion配置</h2>

                    <div class="notion-config-card">
                        <div class="config-header">
                            <h3>连接您的Notion数据库</h3>
                            <p>配置您的Notion API密钥和数据库ID以开始导入账单</p>
                        </div>

                        <!-- 配置状态 -->
                        <div class="config-status" id="config-status">
                            <div class="config-status-icon" id="config-status-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                            </div>
                            <div class="config-status-text">
                                <h4 id="config-status-title">未配置</h4>
                                <p id="config-status-desc">您还没有配置Notion集成</p>
                            </div>
                        </div>

                        <form id="notion-config-form">
                            <div class="form-group">
                                <label>配置名称</label>
                                <input type="text" id="config-name" class="form-input" value="默认配置">
                                <div class="form-hint">为您的配置起一个便于识别的名称</div>
                            </div>

                            <div class="form-group">
                                <label>Notion API密钥</label>
                                <div class="input-with-icon">
                                    <input type="password" id="notion-api-key" class="form-input" placeholder="secret_..." required>
                                    <button type="button" class="input-icon" id="toggle-api-key" aria-label="显示/隐藏API密钥">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="form-hint">
                                    在<a href="https://www.notion.so/my-integrations" target="_blank" class="link">Notion集成页面</a>创建集成以获取API密钥
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>收入数据库ID</label>
                                    <input type="text" id="income-db-id" class="form-input" placeholder="abc123..." required>
                                    <div class="form-hint">从收入数据库URL中复制</div>
                                </div>

                                <div class="form-group">
                                    <label>支出数据库ID</label>
                                    <input type="text" id="expense-db-id" class="form-input" placeholder="def456..." required>
                                    <div class="form-hint">从支出数据库URL中复制</div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" id="verify-config-btn">
                                    ✓ 验证配置
                                </button>
                                <button type="submit" class="btn btn-primary">保存配置</button>
                            </div>
                        </form>

                        <!-- 验证结果 -->
                        <div class="verification-result" id="verification-result" style="display: none;">
                            <!-- 动态显示验证结果 -->
                        </div>
                    </div>
                </section>

                <!-- 复盘配置卡片 -->
                <section class="settings-section" id="review-section" style="display: none;">
                    <h2>复盘配置</h2>

                    <div class="review-config-card">
                        <div class="config-header">
                            <h3>配置账单复盘功能</h3>
                            <p>设置复盘数据库和模板，自动生成月度、季度、年度账单复盘报告</p>
                        </div>

                        <!-- 配置说明 -->
                        <div class="info-banner" style="margin-bottom: 24px;">
                            <svg class="info-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            <div class="info-content">
                                <h4>什么是复盘？</h4>
                                <p>复盘功能会根据您的账单数据自动生成分析报告，帮助您了解收支情况、消费习惯和财务趋势。</p>
                            </div>
                        </div>

                        <form id="review-config-form">
                            <!-- 月度复盘配置 -->
                            <div class="config-group">
                                <h4>月度复盘</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>复盘数据库ID</label>
                                        <input type="text" id="monthly-review-db" class="form-input" placeholder="abc123...">
                                        <div class="form-hint">Notion复盘数据库ID（可选）</div>
                                    </div>

                                    <div class="form-group">
                                        <label>模板页面ID</label>
                                        <input type="text" id="monthly-template-id" class="form-input" placeholder="template_id">
                                        <div class="form-hint">复盘模板页面ID（可选）</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 季度复盘配置 -->
                            <div class="config-group">
                                <h4>季度复盘</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>复盘数据库ID</label>
                                        <input type="text" id="quarterly-review-db" class="form-input" placeholder="abc123...">
                                        <div class="form-hint">Notion复盘数据库ID（可选）</div>
                                    </div>

                                    <div class="form-group">
                                        <label>模板页面ID</label>
                                        <input type="text" id="quarterly-template-id" class="form-input" placeholder="template_id">
                                        <div class="form-hint">复盘模板页面ID（可选）</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 年度复盘配置 -->
                            <div class="config-group">
                                <h4>年度复盘</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>复盘数据库ID</label>
                                        <input type="text" id="yearly-review-db" class="form-input" placeholder="abc123...">
                                        <div class="form-hint">Notion复盘数据库ID（可选）</div>
                                    </div>

                                    <div class="form-group">
                                        <label>模板页面ID</label>
                                        <input type="text" id="yearly-template-id" class="form-input" placeholder="template_id">
                                        <div class="form-hint">复盘模板页面ID（可选）</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" id="load-review-config-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="23 4 23 10 17 10"/>
                                        <polyline points="1 20 1 14 7 14"/>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                    </svg>
                                    重新加载
                                </button>
                                <button type="submit" class="btn btn-primary">保存配置</button>
                            </div>
                        </form>

                        <!-- 快速链接 -->
                        <div class="quick-links">
                            <h4>快速操作</h4>
                            <a href="/review" class="quick-link">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                                <span>前往复盘管理页面</span>
                                <span class="arrow">→</span>
                            </a>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- 消息提示容器 -->
    <div id="toast-container" style="position: fixed; top: 80px; right: 24px; z-index: 2000;"></div>

    <!-- 性能优化工具库 -->
    <script src="/static/js/perf-utils.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/navbar.js"></script>
    <script src="/static/js/settings.js"></script>

    <style>
    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
        font-size: 0.95rem;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.2s ease;
        background: #f9fafb;
    }

    .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .form-input[readonly] {
        background: #f3f4f6;
        cursor: not-allowed;
    }

    .input-with-icon {
        position: relative;
    }

    .input-with-icon .form-input {
        padding-right: 48px;
    }

    .input-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
    }

    .form-hint {
        margin-top: 6px;
        font-size: 0.875rem;
        color: #9ca3af;
    }

    .password-strength {
        margin-top: 12px;
    }

    .strength-bar {
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
    }

    .strength-fill {
        height: 100%;
        width: 0%;
        transition: all 0.3s ease;
    }

    .strength-fill.weak {
        width: 33%;
        background: #ef4444;
    }

    .strength-fill.medium {
        width: 66%;
        background: #f59e0b;
    }

    .strength-fill.strong {
        width: 100%;
        background: #10b981;
    }

    .strength-text {
        margin-top: 8px;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .badge-success {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }

    /* Toast 样式 */
    .toast {
        padding: 14px 20px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        margin-bottom: 12px;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        border-left: 4px solid #10b981;
    }

    .toast.error {
        border-left: 4px solid #ef4444;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* ==================== 验证进度样式 ==================== */

    .verify-progress-container {
        padding: 20px;
        background: #f9fafb;
        border-radius: 12px;
        margin-top: 20px;
    }

    .verify-progress-container h4 {
        margin: 0 0 16px 0;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
    }

    .verify-progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .verify-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
    }

    .verify-steps {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .verify-step {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .verify-step.in-progress {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .verify-step.success {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.05);
    }

    .verify-step.error {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.05);
    }

    .step-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 14px;
        flex-shrink: 0;
        background: #f3f4f6;
        color: #6b7280;
    }

    .step-icon.spinning {
        background: #667eea;
        color: white;
        animation: spin 1s linear infinite;
    }

    .step-icon.success {
        background: #10b981;
        color: white;
    }

    .step-icon.error {
        background: #ef4444;
        color: white;
    }

    .step-text {
        flex: 1;
        font-size: 0.9rem;
        color: #374151;
    }

    .verify-step.error .step-text {
        color: #dc2626;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    /* ==================== 复盘配置样式 ==================== */

    .review-config-card {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
    }

    .config-header {
        margin-bottom: 24px;
    }

    .config-header h3 {
        margin: 0 0 8px 0;
        font-size: 1.25rem;
        color: #1a1a2e;
    }

    .config-header p {
        margin: 0;
        color: #6b7280;
        font-size: 0.95rem;
    }

    .info-banner {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: rgba(102, 126, 234, 0.08);
        border-radius: 12px;
        border-left: 4px solid #667eea;
    }

    .info-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .info-content h4 {
        margin: 0 0 4px 0;
        font-size: 1rem;
        color: #1a1a2e;
    }

    .info-content p {
        margin: 0;
        font-size: 0.9rem;
        color: #6b7280;
        line-height: 1.5;
    }

    .config-group {
        margin-bottom: 24px;
        padding: 20px;
        background: #f9fafb;
        border-radius: 12px;
    }

    .config-group h4 {
        margin: 0 0 16px 0;
        font-size: 1rem;
        color: #374151;
        font-weight: 600;
    }

    .quick-links {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
    }

    .quick-links h4 {
        margin: 0 0 12px 0;
        font-size: 0.95rem;
        color: #6b7280;
        font-weight: 600;
    }

    .quick-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        text-decoration: none;
        color: #374151;
        transition: all 0.2s ease;
    }

    .quick-link:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .quick-link .arrow {
        margin-left: auto;
        color: #667eea;
        font-weight: 600;
    }
    </style>
</body>
</html>
